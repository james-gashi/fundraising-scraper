<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StrictlyVC Job Finder</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0f1117; color: #e1e4e8; min-height: 100vh; }
  .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
  header { text-align: center; padding: 32px 0 24px; }
  header h1 { font-size: 28px; font-weight: 700; color: #f0f0f0; }
  header p { color: #8b949e; margin-top: 6px; font-size: 14px; }
  .controls { display: flex; justify-content: center; align-items: center; gap: 16px; margin: 24px 0; }
  .btn { padding: 12px 32px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
  .btn-primary { background: #238636; color: #fff; }
  .btn-primary:hover { background: #2ea043; }
  .btn-primary:disabled { background: #1a2a1f; color: #4a6a4f; cursor: not-allowed; }
  .progress-bar { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 12px 20px; margin: 0 auto 24px; max-width: 600px; text-align: center; font-size: 14px; color: #8b949e; min-height: 44px; display: flex; align-items: center; justify-content: center; gap: 10px; }
  .spinner { width: 18px; height: 18px; border: 2px solid #30363d; border-top-color: #58a6ff; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
  .spinner.active { display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .summary { display: flex; justify-content: center; gap: 24px; margin-bottom: 24px; flex-wrap: wrap; }
  .stat { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 12px 20px; text-align: center; min-width: 120px; }
  .stat .num { font-size: 24px; font-weight: 700; color: #58a6ff; }
  .stat .label { font-size: 12px; color: #8b949e; margin-top: 2px; }
  .tabs { display: flex; gap: 0; margin-bottom: 0; border-bottom: 1px solid #30363d; }
  .tab { padding: 10px 24px; font-size: 14px; font-weight: 500; background: none; border: none; color: #8b949e; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
  .tab:hover { color: #e1e4e8; }
  .tab.active { color: #f0f0f0; border-bottom-color: #58a6ff; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .table-wrap { overflow-x: auto; background: #161b22; border: 1px solid #30363d; border-top: none; border-radius: 0 0 8px 8px; max-height: 600px; overflow-y: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead { position: sticky; top: 0; z-index: 1; }
  th { background: #1c2128; padding: 10px 12px; text-align: left; font-weight: 600; color: #8b949e; border-bottom: 1px solid #30363d; white-space: nowrap; }
  td { padding: 8px 12px; border-bottom: 1px solid #21262d; color: #c9d1d9; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  tr:hover td { background: #1c2128; }
  td a { color: #58a6ff; text-decoration: none; }
  td a:hover { text-decoration: underline; }
  .empty { text-align: center; padding: 48px 20px; color: #484f58; font-size: 14px; }
  .section-tag { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .section-tag.massive { background: #2a1f3d; color: #bc8cff; }
  .section-tag.big { background: #1f2d3d; color: #79c0ff; }
  .section-tag.smaller { background: #1f3d2a; color: #7ee787; }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>StrictlyVC Job Finder</h1>
    <p>Scrape recently funded startups and find entry-level tech/sales jobs in NYC</p>
  </header>

  <div class="controls">
    <button class="btn btn-primary" id="runBtn" onclick="startRun()">Search for Jobs</button>
  </div>

  <div class="progress-bar" id="progress">
    <div class="spinner" id="spinner"></div>
    <span id="progressText">Click the button to start searching.</span>
  </div>

  <div class="summary" id="summary" style="display:none">
    <div class="stat"><div class="num" id="statArticles">0</div><div class="label">Articles</div></div>
    <div class="stat"><div class="num" id="statFundings">0</div><div class="label">Fundings</div></div>
    <div class="stat"><div class="num" id="statCompanies">0</div><div class="label">Companies</div></div>
    <div class="stat"><div class="num" id="statJobs">0</div><div class="label">Jobs Found</div></div>
  </div>

  <div class="tabs" id="tabs" style="display:none">
    <button class="tab active" onclick="switchTab('fundings', this)">Fundings</button>
    <button class="tab" onclick="switchTab('jobs', this)">Jobs</button>
    <button class="tab" onclick="switchTab('combined', this)">Combined</button>
  </div>

  <div class="tab-content active" id="panel-fundings"></div>
  <div class="tab-content" id="panel-jobs"></div>
  <div class="tab-content" id="panel-combined"></div>
</div>

<script>
let pollTimer = null;

function startRun() {
  document.getElementById('runBtn').disabled = true;
  document.getElementById('spinner').classList.add('active');
  document.getElementById('progressText').textContent = 'Starting pipeline...';
  document.getElementById('summary').style.display = 'none';
  document.getElementById('tabs').style.display = 'none';
  document.querySelectorAll('.tab-content').forEach(p => { p.innerHTML = ''; p.classList.remove('active'); });
  document.querySelector('.tab-content').classList.add('active');

  fetch('/api/run', { method: 'POST' })
    .then(r => r.json())
    .then(() => { pollTimer = setInterval(pollStatus, 2000); })
    .catch(() => {
      document.getElementById('progressText').textContent = 'Failed to start. Is the server running?';
      document.getElementById('spinner').classList.remove('active');
      document.getElementById('runBtn').disabled = false;
    });
}

function pollStatus() {
  fetch('/api/status')
    .then(r => r.json())
    .then(data => {
      document.getElementById('progressText').textContent = data.progress || '';
      if (data.status === 'done' || data.status === 'error') {
        clearInterval(pollTimer);
        pollTimer = null;
        document.getElementById('spinner').classList.remove('active');
        document.getElementById('runBtn').disabled = false;

        if (data.status === 'done' && data.summary) {
          showSummary(data.summary);
          showData(data);
        }
      }
    });
}

function showSummary(s) {
  document.getElementById('statArticles').textContent = s.articles_scraped || 0;
  document.getElementById('statFundings').textContent = s.parsed || 0;
  document.getElementById('statCompanies').textContent = s.companies_searched || 0;
  document.getElementById('statJobs').textContent = s.jobs_found || 0;
  document.getElementById('summary').style.display = 'flex';
}

function showData(data) {
  document.getElementById('tabs').style.display = 'flex';

  renderFundings(data.fundings || []);
  renderJobs(data.jobs || []);
  renderCombined(data.combined || []);
}

function sectionTag(section) {
  if (!section) return '';
  const s = section.toLowerCase();
  let cls = 'smaller';
  if (s.includes('massive')) cls = 'massive';
  else if (s.includes('big')) cls = 'big';
  return `<span class="section-tag ${cls}">${section}</span>`;
}

function renderFundings(rows) {
  const el = document.getElementById('panel-fundings');
  if (!rows.length) { el.innerHTML = '<div class="empty">No funding entries found.</div>'; return; }
  let html = '<div class="table-wrap"><table><thead><tr><th>Company</th><th>Amount</th><th>Round</th><th>Location</th><th>Section</th><th>Lead Investor</th><th>Source</th></tr></thead><tbody>';
  rows.forEach(r => {
    html += `<tr>
      <td><strong>${esc(r.company)}</strong></td>
      <td>$${esc(r.amount)}</td>
      <td>${esc(r.round)}</td>
      <td>${esc(r.location)}</td>
      <td>${sectionTag(r.section)}</td>
      <td>${esc(r.lead_investor)}</td>
      <td>${r.source_url ? `<a href="${esc(r.source_url)}" target="_blank">Article</a>` : ''}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  el.innerHTML = html;
}

function renderJobs(rows) {
  const el = document.getElementById('panel-jobs');
  if (!rows.length) { el.innerHTML = '<div class="empty">No matching jobs found.</div>'; return; }
  let html = '<div class="table-wrap"><table><thead><tr><th>Title</th><th>Company</th><th>Location</th><th>Salary</th><th>Remote</th><th>Searched For</th><th>Link</th></tr></thead><tbody>';
  rows.forEach(r => {
    const salary = formatSalary(r.min_amount, r.max_amount, r.currency);
    html += `<tr>
      <td><strong>${esc(r.title)}</strong></td>
      <td>${esc(r.company)}</td>
      <td>${esc(r.location)}</td>
      <td>${salary}</td>
      <td>${r.is_remote ? 'Yes' : ''}</td>
      <td>${esc(r.searched_company)}</td>
      <td>${r.job_url ? `<a href="${esc(r.job_url)}" target="_blank">Apply</a>` : ''}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  el.innerHTML = html;
}

function renderCombined(rows) {
  const el = document.getElementById('panel-combined');
  if (!rows.length) { el.innerHTML = '<div class="empty">No combined results.</div>'; return; }
  let html = '<div class="table-wrap"><table><thead><tr><th>Job Title</th><th>Company</th><th>Location</th><th>Funding</th><th>Round</th><th>Section</th><th>Link</th></tr></thead><tbody>';
  rows.forEach(r => {
    html += `<tr>
      <td><strong>${esc(r.title)}</strong></td>
      <td>${esc(r.company)}</td>
      <td>${esc(r.location)}</td>
      <td>${r.amount ? '$' + esc(r.amount) : ''}</td>
      <td>${esc(r.round)}</td>
      <td>${sectionTag(r.section)}</td>
      <td>${r.job_url ? `<a href="${esc(r.job_url)}" target="_blank">Apply</a>` : ''}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  el.innerHTML = html;
}

function formatSalary(min, max, cur) {
  if (!min && !max) return '';
  const c = cur || 'USD';
  const fmt = n => {
    n = parseFloat(n);
    if (isNaN(n)) return '';
    return n >= 1000 ? `${Math.round(n / 1000)}k` : `${n}`;
  };
  if (min && max) return `$${fmt(min)}-$${fmt(max)}`;
  if (min) return `$${fmt(min)}+`;
  return `Up to $${fmt(max)}`;
}

function esc(s) {
  if (s === null || s === undefined) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

function switchTab(name, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('panel-' + name).classList.add('active');
}
</script>
</body>
</html>
